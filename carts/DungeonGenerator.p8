pico-8 cartridge // http://www.pico-8.com
version 18
__lua__

left,right,up,down,fire1,fire2=0,1,2,3,4,5
black,yellow,light_green,green,dark_green,blue_green,light_blue,blue,navy,dark_blue,purple,light_purple,white,beige,orange,brown=0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15

player = {
  x = 0;
  y = 0;
  speed = 2;
}

dungeon = {
  tiles = {}
}

function _init()
  poke(0x5f11, 122)
  poke(0x5f12, 138)
  poke(0x5f13, 139)
  poke(0x5f14, 115)
  poke(0x5f15, 131)
  poke(0x5f16, 124)
  poke(0x5f17, 140)
  poke(0x5f18, 113)
  poke(0x5f19, 129)
  poke(0x5f1a, 130)
  poke(0x5f1b, 141)
  poke(0x5f1c, 119)
  poke(0x5f1d, 127)
  poke(0x5f1e, 121)
  poke(0x5f1f, 132)
  make_map()
end


function make_map() 
  srand(98345872347)
  room_centers = {}
  for y=1,64 do
    dungeon.tiles[y] = {}
    for x=1,128 do
      dungeon.tiles[y][x] = flr(rnd(50)) == 2 and 64 or 0
      if(dungeon.tiles[y][x] == 64) then
        room_centers[#room_centers+1] = {x = x; y = y;}
        for sy=-5,0 do
          for sx=-5,0 do
            if(y + sy > 0 and x + sx > 0)then
              dungeon.tiles[y+sy][x+sx] = 64
            end
          end
        end
      end
    end
  end
  while(#room_centers > 1) do
    p1 = room_centers[#room_centers - 1]
    closest = {}
    smallest_distance = 10000
    for room in all(room_centers) do
      distance = flr(sqrt((p1.x - room.x) ^ 2 + (p1.y - room.y) ^ 2))
      if(distance < smallest_distance and distance != 0) then
        smallest_distance = distance
        closest = room
      end
    end
    distance = {x = p1.x - closest.x; y = p1.y - closest.y; }
    x_is_biggest = abs(distance.x) > abs(distance.y)
    if(x_is_biggest) then
      for x=1,flr(distance.x / 2), distance.x > 0 and 1 or -1 do
        if(inBounds(p1.x + x, p1.y)) then
          dungeon.tiles[p1.y][p1.x + x] = 64
          dungeon.tiles[p1.y + 1][p1.x + x] = 64
        end
      end
      for y=1,distance.y, distance.y > 0 and 1 or -1 do
        if(inBounds(p1.x + flr(distance.x / 2), p1.y + y)) then
          dungeon.tiles[p1.y + y][p1.x + flr(distance.x / 2)] = 64
          dungeon.tiles[p1.y + y][p1.x + flr(distance.x / 2) + 1] = 64
        end
      end
      for x=flr(distance.x / 2),distance.x, distance.x > 0 and 1 or -1 do
        if(inBounds(p1.x + x, p1.y + distance.y)) then
          dungeon.tiles[p1.y + distance.y][p1.x + x] = 64
          dungeon.tiles[p1.y + distance.y + 1][p1.x + x] = 64
        end
      end
    end
    if(not x_is_biggest) then
      for y=1,flr(distance.y / 2), distance.y > 0 and 1 or -1 do
        if(inBounds(p1.x, p1.y + y)) then
          dungeon.tiles[p1.y + y][p1.x] = 64
          dungeon.tiles[p1.y + y][p1.x + 1] = 64
        end
      end
      for x=1,distance.x, distance.x > 0 and 1 or -1 do
        if(inBounds(p1.x + x, p1.y + flr(distance.y / 2))) then
          printh(p1.x + x .. " " .. p1.y + flr(distance.y / 2))
          dungeon.tiles[p1.y + flr(distance.y / 2)][p1.x + x] = 64
          dungeon.tiles[p1.y + flr(distance.y / 2) + 1][p1.x + x] = 64
        end
      end
      for y=flr(distance.y / 2),distance.y, distance.y > 0 and 1 or -1 do
        if(inBounds(p1.x + distance.x, p1.y + y)) then
          dungeon.tiles[p1.y + y][p1.x + distance.x] = 64
          dungeon.tiles[p1.y + y][p1.x + distance.x + 1] = 64
        end
      end
    end
    del(room_centers, p1)
  end
  for y=1,64 do
    for x=1,128 do
      type = 0
      if(inBounds(x, y+1) and dungeon.tiles[y+1][x] == 64) then
        type += 1
      end
      if(inBounds(x+1, y+1) and dungeon.tiles[y+1][x + 1] == 64) then
        type += 2
      end
      if(inBounds(x+1, y) and dungeon.tiles[y][x+1] == 64) then
        type += 4
      end
      if(inBounds(x, y) and dungeon.tiles[y][x] == 64) then
        type += 8
      end
      dungeon.tiles[y][x] = 128 + type
    end
  end
end

function inBounds(x, y)
  return (x > 0 and x < 128 and y > 0 and y < 64)
end


function _update()
  if(btn(left)) then 
    player.x += player.speed
  --   -- if(cantMoveHere({x = 64; y = 64;})) then
  --   --   player.x -= 1
  --   -- end
  --   tile -= 1
  end
  if(btn(right)) then 
    player.x -= player.speed
  --   -- if(cantMoveHere({x = 64; y = 64;})) then
  --   --   player.x += 1
  --   -- end 
  --   tile += 1
  end
  if(btn(up)) then 
    player.y += player.speed
  --   -- if(cantMoveHere({x = 64; y = 64;})) then
  --   --   player.y -= 1
  --   -- end
  end
  if(btn(down)) then 
    player.y -= player.speed 
  --   -- if(cantMoveHere({x = 64; y = 64;})) then
  --   --   player.y += 1
  --   -- end
  end
  -- if(btnp(0)) then test_tile -= 1 end
  -- if(btnp(1)) then test_tile += 1 end
end

draw = true
function _draw()
  if( draw ) then 
    rectfill(0,0,128,128,black)

    draw_dungeon()
    draw = false
  end
  cls()
  draw_map()
end


function draw_tiles()
  size = 8
  bottom = {x = 0; y = 1 * size;}
  top = {x = 0; y = -1 * size;}
  left = {x = -1 * size; y = 0;}
  right = {x = 1 * size; y = 0;}
  br = { x = 1 * size; y = 1 * size;}
  bl = { x = -1 * size; y = 1 * size;}
  ul = { x = -1 * size; y = -1 * size;}
  ur = { x = 1 * size; y = -1 * size;}
  if (band(test_tile, 0x01) == 1) then
    spr(64, bottom.x + 40, bottom.y + 40)
  end
  if (band(test_tile, 0x02) == 2) then
    spr(64, left.x + 40, left.y + 40)
  end
  if (band(test_tile, 0x04) == 4) then
    spr(64, top.x + 40, top.y + 40)
  end
  if (band(test_tile, 0x08) == 8) then
    spr(64, right.x + 40, right.y + 40)
  end
  if (band(test_tile, 0x10) == 16) then
    spr(64, br.x + 40, br.y + 40)
  end
  if (band(test_tile, 0x20) == 32) then
    spr(64, bl.x + 40, bl.y + 40)
  end
  if (band(test_tile, 0x40) == 64) then
    spr(64, ul.x + 40, ul.y + 40)
  end
  if (band(test_tile, 0x80) == 128) then
    spr(64, ur.x + 40, ur.y + 40)
  end
  spr(test_tile + 127, 40,40)
end

function draw_dungeon()
  for y=1,64 do
    for x=1,128 do
      position = (y * 128 + x) - 1
      tile = dungeon.tiles[y][x]
      poke(0x2000 + position, tile)
    end
  end
end

function draw_map()
  map(0,0,player.x,player.y,128,128)
end

function draw_player()
  spr(1,64,64)
end

function cantMoveHere(thing)
  tile_num_left = mget((((player.x * -1) + thing.x) + 1) / 8, (((player.y * -1)  + thing.y) + 7) / 8)
  tile_num_right = mget((((player.x * -1) + thing.x) + 6) / 8, (((player.y * -1)  + thing.y) + 7) / 8)
  print(tile_num_right,0,0, white)
  return tile_num_left != 64 or tile_num_right != 64
end

__gfx__
0000000000000000000011112222333388889999aaaabbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000fffff0000011112222333388889999aaaabbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000ffddd00000011112222333388889999aaaabbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000fd7d700000011112222333388889999aaaabbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000dddd004444555566667777ccccddddeeeeffff00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000005555004444555566667777ccccddddeeeeffff00000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000daaaad04444555566667777ccccddddeeeeffff00000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000b00b004444555566667777ccccddddeeeeffff00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
89999998898888880000000000000000000000000000000000000000000000001111111144444444000000000000000000000000000000000000000000000000
98888888898888880000000000000000000000000000000000000000000000001111111144444444000000000000000000000000000000000000000000000000
98888888898888880000000000000000000000000000000000000000000000001111111144444444000000000000000000000000000000000000000000000000
98888888999999999999999900000999999000000000000000000000000000001111111144444444000000000000000000000000000000000000000000000000
98888888888888989999999900000999999000000000000000000000000000001111111144444444000000000000000000000000000000000000000000000000
98888888888888989999999900000999999000000000000000000000000000001111111144444444000000000000000000000000000000000000000000000000
98888888888888988898889800000999999000000000000000000000000000001111111144444444000000000000000000000000000000000000000000000000
88888888999999999999999900000999999000000000000000000000000000001111111144444444000000000000000000000000000000000000000000000000
99999999797778780000099900000999999000009990000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999877177880000099900000999999000009990000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999771e17780000099900000999999000009990000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88988898797f79799999999900000999999000009999999900000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999878f87989999999900000999999000009999999900000000000000000000000000000000000000000000000000000000000000000000000000000000
90909090888888989999999900000999999000009999999900000000000000000000000000000000000000000000000000000000000000000000000000000000
09090909888888988898889800000999999000008988898800000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000999999999999999900000999999000009999999900000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000090909000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000909090000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000999999999999999999999999998898899889889999889889888988999889889998898899998898899988988899999999899999999999999889999998
00000000999999999999999999999999998898988898899999889889889889988989889998898899999889889998898888888988988888999988888898888888
00000000888889999998888888888988998899888988999899999889898899888899889999998899899988989899889888888988988889988998888898888888
00000000888898999989888888888988998899999889998899889889988998889999889998898899889998899889988999999999988899888899888898888888
00000000999988999988999999999999998988888899988999889889889988888888989998898899988999889888998888988888988998899889988898888888
00000000889988999988998888988888999888888999889899889999899888888888899998899999898899989888899888988888989988988988998898888888
00000000898988999988989888988888999999999998898899889889998888889999999998898899889889999888889999999999999889888898899898888888
00000000988988999988988999999999999999999988988999889889988888889999999998898899988988998888888999999999998898888889889988888888
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999999000009999999999999999999999999999999999999999999009999990099999900999999999999999999999999999889999888888888899900999
99999999999000009999999999999999999999999999999999999999999009999990099999900999999999999999999999999999899999988899998899900999
89888888999000009998888899999999999999999999999999999999999009999999999999900999999999999999999999999999999999998989989899900999
99999999999000009999999988988898999999999998889899999999999009990099999999900999999999998898899999999999999999998998899899900999
88888898999000009998889899999999888888989999999999988898999009990099999999900999999889999999999988888898999999998998899899900999
88888898999000009998889890909090888888989990909099988898909009999999999999900999998888999090999988888898999999998989989890900999
88888898999000009998889809090909888888989999090999988898090009999999999999900999988888890909099988888898999999998899998809000999
99999999999000009999999900000000999999999990000099999999000009999999999999900999999999990000099999999999999999998888888800000999
99999999999009999999999999999999999999999999999999999999999009999999999999900999999999999999999999999999889999888888888899900000
99999999999009999999999999999999999999999999999999999999999009999999999999900999999999999999999999999999899999988899998899900000
99999999999009999999999999999999999999999999999999999999999009999999999999900999999999999999999999999999999999998989989899900000
99999999999009999999999988988999999999999998899999999999999009999999999999900999999999998898899999999999999999998998899899900000
88888898999009999998889899999999888888989999999999988898999009998988899999900999999889999999999989888999999999998998899899900000
88888898999009999998889890909999888888989990099999988898909009998988899999900999998888999090999989888999999999998989989899900000
88888898999009999998889809090999888888989990099999988898090009998988899999900999988888890909099989888999999999998899998899900000
99999999999009999999999900000999999999999990099999999999000009999999999999900999999999990000099999999999999999998888888899900000
99999999999000009999999999999999999999999999999999999999999009999999999999900999999999999999999900000000000000000000000000000000
99999999999000009999999999999999999999999999999999999999999009999999999999900999999999999999999900000000000000000000000000000000
89888888999000009998888899999999999999999999999999999999999009999999999999900999999999999999999900000000000000000000000000000000
99999999999000009999999999988898999999999998889899999999999009999999999999900999999999999998899900000000000000000000000000000000
88888898999000009998889899999999888888989999999999988898999009998988899999900999999889999999999900000000000000000000000000000000
88888898999000009998889899909090888888989990909099988898999009998988899999900999998888999990099900000000000000000000000000000000
88888898999000009998889899990909888888989999090999988898999009998988899999900999988888899990099900000000000000000000000000000000
99999999999000009999999999900000999999999990000099999999999009999999999999900999999999999990099900000000000000000000000000000000
__map__
0203000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0405000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000043424242440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000053414141540000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000053404040540000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000434252404040554242424400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000534151404040514141415400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000534040404040404040405400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000534040404040404040405542424242000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000534040404040404040405141414151000000000000000048490000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000534040404040404040404040404040000000000000000049000000000000004000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00005340404040404040404040404040400000000000000000000000000000000000a7400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000635050505050505050505050505050000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
